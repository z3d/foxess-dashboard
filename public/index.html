<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="robots" content="noindex, nofollow, noarchive, nosnippet">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="FoxESS">
  <meta name="theme-color" content="#1a1a2e">
  <!-- AI: Bump version (semver) when making changes to this file -->
  <meta name="app-version" content="1.5.0">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%231a1a2e' width='100' height='100' rx='20'/><text x='50' y='65' font-size='50' text-anchor='middle' fill='%234ade80'>âš¡</text></svg>">
  <title>FoxESS Battery Monitor</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-box-sizing: border-box;
    }

    html, body {
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      background: -webkit-linear-gradient(315deg, #1a1a2e 0%, #16213e 100%);
      color: #e4e4e4;
      font-size: 28px;
      -webkit-font-smoothing: antialiased;
      -webkit-text-size-adjust: 100%;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      min-height: 100%;
    }

    .header {
      display: -webkit-box;
      display: -webkit-flex;
      display: flex;
      -webkit-box-pack: justify;
      -webkit-justify-content: space-between;
      justify-content: space-between;
      -webkit-box-align: center;
      -webkit-align-items: center;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .header-left {
      display: -webkit-box;
      display: -webkit-flex;
      display: flex;
      -webkit-box-align: center;
      -webkit-align-items: center;
      align-items: center;
    }

    .header h1 {
      font-size: 0.8em;
      font-weight: 500;
      color: #888;
      margin-right: 15px;
    }

    .header-time {
      font-size: 2.5em;
      font-weight: 600;
      color: #fff;
    }

    .header-buttons {
      display: -webkit-box;
      display: -webkit-flex;
      display: flex;
    }

    .header-buttons .btn {
      margin-left: 10px;
    }

    .btn {
      background: rgba(255,255,255,0.1);
      border: none;
      color: #fff;
      padding: 8px 12px;
      border-radius: 8px;
      -webkit-border-radius: 8px;
      font-size: 0.9em;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      -webkit-appearance: none;
    }

    .btn:active {
      background: rgba(255,255,255,0.2);
    }

    .status-indicator {
      display: -webkit-box;
      display: -webkit-flex;
      display: flex;
      -webkit-box-align: center;
      -webkit-align-items: center;
      align-items: center;
      font-size: 0.6em;
      color: #888;
    }

    .status-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      -webkit-border-radius: 50%;
      margin-right: 6px;
      background: #666;
    }

    .status-dot.online {
      background: #4ade80;
    }

    .status-dot.error {
      background: #f87171;
    }

    /* Battery Section */
    .battery-section {
      background: rgba(255,255,255,0.05);
      border-radius: 16px;
      -webkit-border-radius: 16px;
      padding: 20px;
      margin-bottom: 15px;
      display: -webkit-box;
      display: -webkit-flex;
      display: flex;
      -webkit-box-pack: justify;
      -webkit-justify-content: space-between;
      justify-content: space-between;
      -webkit-box-align: center;
      -webkit-align-items: center;
      align-items: center;
    }

    .battery-container {
      display: -webkit-box;
      display: -webkit-flex;
      display: flex;
      -webkit-box-align: center;
      -webkit-align-items: center;
      align-items: center;
    }

    .weather-panel {
      text-align: right;
      padding-left: 20px;
    }

    .weather-panel.hidden {
      display: none;
    }

    .weather-temp {
      font-size: 3em;
      font-weight: 700;
      color: #60a5fa;
      line-height: 1;
    }

    .weather-temp .unit {
      font-size: 0.4em;
      color: #888;
    }

    .weather-condition {
      font-size: 0.7em;
      margin-right: 4px;
      vertical-align: middle;
    }

    .weather-details {
      margin-top: 10px;
    }

    .weather-item {
      font-size: 0.9em;
      color: #ccc;
      margin-top: 4px;
    }

    .weather-label {
      color: #888;
      margin-right: 8px;
    }

    .dewpoint-value {
      display: inline;
    }

    .dewpoint-emoji {
      display: inline;
      margin-left: 4px;
    }

    /* Dew point comfort levels */
    .dewpoint-dry { color: #60a5fa; }
    .dewpoint-comfortable { color: #4ade80; }
    .dewpoint-ok { color: #a3e635; }
    .dewpoint-sticky { color: #fbbf24; }
    .dewpoint-uncomfortable { color: #fb923c; }
    .dewpoint-humid { color: #f87171; }
    .dewpoint-oppressive { color: #dc2626; }

    .battery-visual {
      position: relative;
      width: 80px;
      height: 140px;
      margin-right: 20px;
      -webkit-flex-shrink: 0;
      flex-shrink: 0;
    }

    .battery-body {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 80px;
      height: 130px;
      border: 3px solid #4ade80;
      border-radius: 8px;
      -webkit-border-radius: 8px;
      overflow: hidden;
    }

    .battery-cap {
      position: absolute;
      top: 0;
      left: 50%;
      margin-left: -15px;
      width: 30px;
      height: 8px;
      background: #4ade80;
      border-radius: 3px 3px 0 0;
      -webkit-border-radius: 3px 3px 0 0;
    }

    .battery-level {
      position: absolute;
      bottom: 3px;
      left: 3px;
      right: 3px;
      background: -webkit-linear-gradient(bottom, #4ade80, #22c55e);
      background: linear-gradient(to top, #4ade80, #22c55e);
      border-radius: 3px;
      -webkit-border-radius: 3px;
      -webkit-transition: height 0.5s ease;
      transition: height 0.5s ease;
    }

    .battery-level.low {
      background: -webkit-linear-gradient(bottom, #f87171, #ef4444);
      background: linear-gradient(to top, #f87171, #ef4444);
    }

    .battery-level.medium {
      background: -webkit-linear-gradient(bottom, #fbbf24, #f59e0b);
      background: linear-gradient(to top, #fbbf24, #f59e0b);
    }

    @-webkit-keyframes reserve-blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    @keyframes reserve-blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    .battery-level.reserve-blink {
      -webkit-animation: reserve-blink 1.5s ease-in-out infinite;
      animation: reserve-blink 1.5s ease-in-out infinite;
    }

    .battery-info {
      -webkit-box-flex: 1;
      -webkit-flex: 1;
      flex: 1;
    }

    .battery-soc {
      font-size: 4em;
      font-weight: 700;
      color: #fff;
      line-height: 1;
    }

    .battery-soc .unit {
      font-size: 0.4em;
      color: #888;
    }

    .battery-status {
      font-size: 1.1em;
      margin-top: 8px;
      padding: 6px 12px;
      border-radius: 20px;
      -webkit-border-radius: 20px;
      display: inline-block;
    }

    .battery-status.charging {
      background: rgba(74, 222, 128, 0.2);
      color: #4ade80;
    }

    .battery-status.discharging {
      background: rgba(251, 191, 36, 0.2);
      color: #fbbf24;
    }

    .battery-status.idle {
      background: rgba(148, 163, 184, 0.2);
      color: #94a3b8;
    }

    .battery-time {
      margin-top: 10px;
      font-size: 0.9em;
    }

    .battery-details {
      margin-top: 6px;
      font-size: 0.75em;
      color: #666;
    }

    .battery-time.charging {
      color: #4ade80;
    }

    .battery-time.discharging {
      color: #f87171;
    }

    .battery-time.hidden {
      display: none;
    }

    /* Stats Grid */
    .stats-grid {
      display: -webkit-box;
      display: -webkit-flex;
      display: flex;
      -webkit-flex-wrap: wrap;
      flex-wrap: wrap;
      margin: 0 -6px 15px -6px;
    }

    .stat-card {
      width: 50%;
      padding: 6px;
    }

    .stat-card-inner {
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      -webkit-border-radius: 12px;
      padding: 15px;
    }

    .stat-label {
      font-size: 0.8em;
      color: #888;
      margin-bottom: 5px;
      display: -webkit-box;
      display: -webkit-flex;
      display: flex;
      -webkit-box-align: center;
      -webkit-align-items: center;
      align-items: center;
    }

    .stat-icon {
      margin-right: 6px;
      font-size: 1.2em;
    }

    .stat-value {
      font-size: 2.2em;
      font-weight: 600;
      color: #fff;
    }

    .stat-value .unit {
      font-size: 0.5em;
      color: #888;
      font-weight: 400;
    }

    .stat-card.solar .stat-value {
      color: #fbbf24;
    }

    .stat-card.load .stat-value {
      color: #60a5fa;
    }

    .stat-card.grid-export .stat-value {
      color: #4ade80;
    }

    .stat-card.grid-import .stat-value {
      color: #f87171;
    }

    .stat-card.grid-import.free-period .stat-value {
      color: #4ade80;
    }

    .free-period-row {
      display: -webkit-box;
      display: -webkit-flex;
      display: flex;
      -webkit-box-align: center;
      -webkit-align-items: center;
      align-items: center;
      margin-bottom: 8px;
    }

    .free-period-row input {
      width: 70px;
      padding: 8px;
      margin-right: 8px;
      text-align: center;
    }

    .free-period-row .period-label {
      color: #888;
      margin-right: 8px;
    }

    .free-period-row .remove-period {
      background: rgba(248, 113, 113, 0.2);
      border: none;
      color: #f87171;
      padding: 6px 10px;
      border-radius: 6px;
      -webkit-border-radius: 6px;
      cursor: pointer;
      margin-left: 8px;
      -webkit-appearance: none;
    }

    /* Settings Panel */
    .settings-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      z-index: 100;
    }

    .settings-overlay.active {
      display: block;
    }

    .settings-panel {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: #1e1e2e;
      border-radius: 20px 20px 0 0;
      -webkit-border-radius: 20px 20px 0 0;
      padding: 20px;
      max-height: 80%;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .settings-header {
      display: -webkit-box;
      display: -webkit-flex;
      display: flex;
      -webkit-box-pack: justify;
      -webkit-justify-content: space-between;
      justify-content: space-between;
      -webkit-box-align: center;
      -webkit-align-items: center;
      align-items: center;
      margin-bottom: 20px;
    }

    .settings-header h2 {
      font-size: 1.2em;
      color: #fff;
    }

    .settings-close {
      background: none;
      border: none;
      color: #888;
      font-size: 1.5em;
      cursor: pointer;
      padding: 5px;
      -webkit-appearance: none;
    }

    .settings-group {
      margin-bottom: 20px;
    }

    .settings-group label {
      display: block;
      font-size: 0.9em;
      color: #888;
      margin-bottom: 8px;
    }

    .settings-group input {
      width: 100%;
      padding: 12px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      -webkit-border-radius: 8px;
      color: #fff;
      font-size: 1em;
      -webkit-appearance: none;
    }

    .settings-group input:focus {
      outline: none;
      border-color: #4ade80;
    }

    .settings-group input[type="checkbox"] {
      -webkit-appearance: checkbox;
      appearance: checkbox;
      width: 20px;
      height: 20px;
      margin-right: 10px;
      vertical-align: middle;
      padding: 0;
      background: none;
      border: none;
      border-radius: 0;
      cursor: pointer;
    }

    .settings-group .checkbox-label {
      display: -webkit-box;
      display: -webkit-flex;
      display: flex;
      -webkit-box-align: center;
      -webkit-align-items: center;
      align-items: center;
      cursor: pointer;
    }

    .settings-save {
      width: 100%;
      padding: 14px;
      background: #4ade80;
      border: none;
      border-radius: 10px;
      -webkit-border-radius: 10px;
      color: #000;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      -webkit-appearance: none;
    }

    .settings-save:active {
      background: #22c55e;
    }

    .settings-reload {
      width: 100%;
      padding: 12px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 10px;
      -webkit-border-radius: 10px;
      color: #888;
      font-size: 0.9em;
      cursor: pointer;
      -webkit-appearance: none;
      margin-top: 12px;
    }

    .settings-reload:active {
      background: rgba(255,255,255,0.2);
    }

    .settings-version {
      text-align: center;
      font-size: 0.7em;
      color: #555;
      margin-top: 15px;
    }

    .update-banner {
      background: rgba(251, 191, 36, 0.2);
      border: 1px solid rgba(251, 191, 36, 0.4);
      border-radius: 12px;
      -webkit-border-radius: 12px;
      padding: 12px 15px;
      margin-bottom: 15px;
      display: -webkit-box;
      display: -webkit-flex;
      display: flex;
      -webkit-box-pack: justify;
      -webkit-justify-content: space-between;
      justify-content: space-between;
      -webkit-box-align: center;
      -webkit-align-items: center;
      align-items: center;
    }

    .update-banner.hidden {
      display: none;
    }

    .update-text {
      color: #fbbf24;
      font-size: 0.8em;
    }

    .update-btn {
      background: #fbbf24;
      border: none;
      color: #000;
      padding: 6px 12px;
      border-radius: 6px;
      -webkit-border-radius: 6px;
      font-size: 0.8em;
      font-weight: 600;
      cursor: pointer;
      -webkit-appearance: none;
    }

    /* Error State */
    .error-message {
      background: rgba(248, 113, 113, 0.1);
      border: 1px solid rgba(248, 113, 113, 0.3);
      border-radius: 12px;
      -webkit-border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
      color: #f87171;
      text-align: center;
    }

    /* Loading State */
    .loading .battery-visual {
      opacity: 0.5;
    }

    /* No config state */
    .no-config {
      text-align: center;
      padding: 40px 20px;
    }

    .no-config h2 {
      color: #fff;
      margin-bottom: 15px;
    }

    .no-config p {
      color: #888;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-left">
        <h1>FoxESS</h1>
        <div class="status-indicator">
          <span class="status-dot" id="statusDot"></span>
          <span id="statusText">Connecting...</span>
        </div>
      </div>
      <div class="header-time" id="currentTime">--:--</div>
      <div class="header-buttons">
        <button class="btn" id="refreshBtn">Refresh</button>
        <button class="btn" id="settingsBtn">Settings</button>
      </div>
    </div>

    <div id="updateBanner" class="update-banner hidden">
      <span class="update-text">Update available</span>
      <button class="update-btn" id="updateBtn">Reload</button>
    </div>

    <div id="noConfig" class="no-config" style="display: none;">
      <h2>Welcome</h2>
      <p>Configure your Worker URL in settings to get started.</p>
      <button class="btn" id="openSettingsBtn">Open Settings</button>
    </div>

    <div id="errorMessage" class="error-message" style="display: none;"></div>

    <div id="dashboard">
      <!-- Battery and Weather Section -->
      <div class="battery-section">
        <div class="battery-container">
          <div class="battery-visual">
            <div class="battery-cap"></div>
            <div class="battery-body">
              <div class="battery-level" id="batteryLevel" style="height: 0%;"></div>
            </div>
          </div>
          <div class="battery-info">
            <div class="battery-soc"><span id="socValue">--</span><span class="unit">%</span></div>
            <div class="battery-status idle" id="batteryStatus">Loading...</div>
            <div class="battery-time hidden" id="batteryTime"></div>
            <div class="battery-details" id="batteryDetails">--</div>
          </div>
        </div>
        <div class="weather-panel" id="weatherPanel">
          <div class="weather-temp"><span id="weatherCondition"></span><span id="weatherTemp">--</span><span class="unit">Â°C</span></div>
          <div class="weather-details">
            <div class="weather-item"><span class="weather-label">Humidity</span><span id="weatherHumidity">--</span>%</div>
            <div class="weather-item">
              <span class="weather-label">Dew Point</span><span class="dewpoint-value" id="weatherDewpoint">--Â°C</span><span class="dewpoint-emoji" id="dewpointEmoji"></span>
            </div>
            <div class="weather-item" id="sunEvent" style="display:none"><span class="weather-label" id="sunLabel"></span><span id="sunTime"></span></div>
          </div>
        </div>
      </div>

      <!-- Stats Grid -->
      <div class="stats-grid">
        <div class="stat-card solar">
          <div class="stat-card-inner">
            <div class="stat-label"><span class="stat-icon">&#9788;</span> Solar</div>
            <div class="stat-value"><span id="solarPower">--</span> <span class="unit">kW</span></div>
          </div>
        </div>
        <div class="stat-card load">
          <div class="stat-card-inner">
            <div class="stat-label"><span class="stat-icon">&#9889;</span> Home Load</div>
            <div class="stat-value"><span id="loadPower">--</span> <span class="unit">kW</span></div>
          </div>
        </div>
        <div class="stat-card grid-export">
          <div class="stat-card-inner">
            <div class="stat-label"><span class="stat-icon">&#8593;</span> Grid Export</div>
            <div class="stat-value"><span id="gridExport">--</span> <span class="unit">kW</span></div>
          </div>
        </div>
        <div class="stat-card grid-import" id="gridImportCard">
          <div class="stat-card-inner">
            <div class="stat-label"><span class="stat-icon">&#8595;</span> Grid Import</div>
            <div class="stat-value"><span id="gridImport">--</span> <span class="unit">kW</span></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings Overlay -->
  <div class="settings-overlay" id="settingsOverlay">
    <div class="settings-panel">
      <div class="settings-header">
        <h2>Settings</h2>
        <button class="settings-close" id="settingsClose">x</button>
      </div>
      <div class="settings-group">
        <label for="workerUrl">Worker URL</label>
        <input type="url" id="workerUrl" placeholder="Defaults to current origin">
      </div>
      <div class="settings-group">
        <label for="apiKey">API Key</label>
        <input type="password" id="apiKey" placeholder="Your API key">
      </div>
      <div class="settings-group">
        <label for="refreshInterval">Refresh Interval (seconds)</label>
        <input type="number" id="refreshInterval" value="180" min="10" max="300">
      </div>
      <div class="settings-group">
        <label for="latitude">Latitude</label>
        <input type="text" id="latitude" placeholder="-27.47">
      </div>
      <div class="settings-group">
        <label for="longitude">Longitude</label>
        <input type="text" id="longitude" placeholder="153.02">
      </div>
      <div class="settings-group">
        <label for="batterySize">Battery Size (kWh)</label>
        <input type="number" id="batterySize" value="41" min="1" max="500" step="0.1">
      </div>
      <div class="settings-group">
        <label for="batteryReserve">Battery Reserve (%)</label>
        <input type="number" id="batteryReserve" value="10" min="0" max="100" step="1">
      </div>
      <div class="settings-group">
        <label for="chargeCutoffHours">Charge Cutoff Before Sunset (hours)</label>
        <input type="number" id="chargeCutoffHours" value="2.5" min="0" max="8" step="0.5">
      </div>
      <div class="settings-group">
        <label>Free Grid Import Periods</label>
        <div id="freePeriodsContainer"></div>
        <button type="button" class="btn" id="addFreePeriod" style="margin-top: 8px;">+ Add Period</button>
      </div>
      <div class="settings-group">
        <label class="checkbox-label">
          <input type="checkbox" id="showWeather">
          Show Weather Panel
        </label>
      </div>
      <div class="settings-group">
        <label class="checkbox-label">
          <input type="checkbox" id="use24hClock">
          Use 24-hour Clock
        </label>
      </div>
      <button class="settings-save" id="settingsSave">Save Settings</button>
      <div style="display:-webkit-box;display:-webkit-flex;display:flex;gap:10px;margin-top:10px;">
        <button type="button" class="btn" id="exportSettings" style="-webkit-box-flex:1;flex:1;">Export Settings</button>
        <button type="button" class="btn" id="importSettings" style="-webkit-box-flex:1;flex:1;">Import Settings</button>
        <input type="file" id="importFileInput" accept=".json" style="display:none;">
      </div>
      <button class="settings-reload" id="settingsReload">Force Reload App</button>
      <div class="settings-version" id="settingsVersion">v1.0.0</div>
    </div>
  </div>

  <script>
    (function() {
      'use strict';

      // Get app version from meta tag
      var versionMeta = document.querySelector('meta[name="app-version"]');
      var APP_VERSION = versionMeta ? versionMeta.getAttribute('content') : '1.0.0';

      var config = {
        workerUrl: window.location.origin,
        apiKey: '',
        refreshInterval: 180,
        latitude: -27.47,
        longitude: 153.02,
        showWeather: true,
        batterySize: 41,
        batteryReserve: 10,
        use24hClock: false,
        chargeCutoffHours: 2.5,
        freePeriods: [{start: 11, end: 14}]
      };

      var refreshTimer = null;
      var countdownTimer = null;
      var nextRefreshTime = 0;
      var lastSuccessfulUpdate = null;
      var todaySunsetUnix = null;
      var elements = {};
      var apiRatedCapacity = null;

      function initElements() {
        elements.statusDot = document.getElementById('statusDot');
        elements.statusText = document.getElementById('statusText');
        elements.currentTime = document.getElementById('currentTime');
        elements.noConfig = document.getElementById('noConfig');
        elements.errorMessage = document.getElementById('errorMessage');
        elements.dashboard = document.getElementById('dashboard');
        elements.batteryLevel = document.getElementById('batteryLevel');
        elements.socValue = document.getElementById('socValue');
        elements.batteryStatus = document.getElementById('batteryStatus');
        elements.batteryDetails = document.getElementById('batteryDetails');
        elements.batteryTime = document.getElementById('batteryTime');
        elements.solarPower = document.getElementById('solarPower');
        elements.loadPower = document.getElementById('loadPower');
        elements.gridExport = document.getElementById('gridExport');
        elements.gridImport = document.getElementById('gridImport');
        elements.gridImportCard = document.getElementById('gridImportCard');
        elements.weatherPanel = document.getElementById('weatherPanel');
        elements.weatherTemp = document.getElementById('weatherTemp');
        elements.weatherCondition = document.getElementById('weatherCondition');
        elements.weatherHumidity = document.getElementById('weatherHumidity');
        elements.weatherDewpoint = document.getElementById('weatherDewpoint');
        elements.dewpointEmoji = document.getElementById('dewpointEmoji');
        elements.sunEvent = document.getElementById('sunEvent');
        elements.sunLabel = document.getElementById('sunLabel');
        elements.sunTime = document.getElementById('sunTime');
        elements.settingsOverlay = document.getElementById('settingsOverlay');
        elements.workerUrl = document.getElementById('workerUrl');
        elements.apiKey = document.getElementById('apiKey');
        elements.refreshInterval = document.getElementById('refreshInterval');
        elements.latitude = document.getElementById('latitude');
        elements.longitude = document.getElementById('longitude');
        elements.showWeather = document.getElementById('showWeather');
        elements.batterySize = document.getElementById('batterySize');
        elements.batteryReserve = document.getElementById('batteryReserve');
        elements.chargeCutoffHours = document.getElementById('chargeCutoffHours');
        elements.freePeriodsContainer = document.getElementById('freePeriodsContainer');
        elements.addFreePeriod = document.getElementById('addFreePeriod');
        elements.use24hClock = document.getElementById('use24hClock');
      }

      function loadConfig() {
        try {
          var saved = localStorage.getItem('foxess_config');
          if (saved) {
            var parsed = JSON.parse(saved);
            config.workerUrl = parsed.workerUrl || window.location.origin;
            config.apiKey = parsed.apiKey || '';
            config.refreshInterval = parsed.refreshInterval || 180;
            config.latitude = parsed.latitude || -27.47;
            config.longitude = parsed.longitude || 153.02;
            config.showWeather = parsed.showWeather !== undefined ? parsed.showWeather : true;
            config.batterySize = parsed.batterySize || 41;
            config.batteryReserve = parsed.batteryReserve !== undefined ? parsed.batteryReserve : 10;
            config.chargeCutoffHours = parsed.chargeCutoffHours !== undefined ? parsed.chargeCutoffHours : 2.5;
            config.use24hClock = parsed.use24hClock !== undefined ? parsed.use24hClock : false;
            config.freePeriods = parsed.freePeriods || [{start: 11, end: 14}];
          }
        } catch (e) {
          // Ignore errors
        }
      }

      function saveConfig() {
        try {
          localStorage.setItem('foxess_config', JSON.stringify(config));
        } catch (e) {
          // Ignore errors
        }
      }

      function forceReload() {
        // Clear caches if available
        if ('caches' in window) {
          caches.keys().then(function(names) {
            names.forEach(function(name) {
              caches.delete(name);
            });
          });
        }
        // Reload with cache busting
        var url = window.location.href.split('?')[0];
        window.location.href = url + '?v=' + Date.now();
      }

      function checkForUpdates() {
        var storedVersion = localStorage.getItem('foxess_app_version');
        if (storedVersion && storedVersion !== APP_VERSION) {
          // New version available - auto-reload
          localStorage.setItem('foxess_app_version', APP_VERSION);
          forceReload();
          return;
        }
        // Store current version
        localStorage.setItem('foxess_app_version', APP_VERSION);
      }

      function updateClock() {
        var now = new Date();
        var hours = now.getHours();
        var minutes = now.getMinutes();
        var mm = minutes < 10 ? '0' + minutes : '' + minutes;

        if (config.use24hClock) {
          var hh = hours < 10 ? '0' + hours : '' + hours;
          elements.currentTime.textContent = hh + ':' + mm;
        } else {
          var period = hours >= 12 ? 'PM' : 'AM';
          var h12 = hours % 12;
          if (h12 === 0) h12 = 12;
          elements.currentTime.textContent = h12 + ':' + mm + ' ' + period;
        }
      }

      function getDewpointComfort(dewpoint) {
        if (dewpoint < 10) return { class: 'dewpoint-dry', emoji: 'ðŸ˜Š', label: 'Dry' };
        if (dewpoint < 13) return { class: 'dewpoint-comfortable', emoji: 'ðŸ™‚', label: 'Comfortable' };
        if (dewpoint < 16) return { class: 'dewpoint-ok', emoji: 'ðŸ˜', label: 'OK' };
        if (dewpoint < 18) return { class: 'dewpoint-sticky', emoji: 'ðŸ˜…', label: 'Sticky' };
        if (dewpoint < 21) return { class: 'dewpoint-uncomfortable', emoji: 'ðŸ˜“', label: 'Uncomfortable' };
        if (dewpoint < 24) return { class: 'dewpoint-humid', emoji: 'ðŸ˜°', label: 'Very Humid' };
        return { class: 'dewpoint-oppressive', emoji: 'ðŸ¥µ', label: 'Oppressive' };
      }

      // WMO Weather interpretation codes to emoji mapping
      function getWeatherEmoji(code) {
        if (code === 0) return 'â˜€ï¸';  // Clear sky
        if (code === 1) return 'ðŸŒ¤ï¸';  // Mainly clear
        if (code === 2) return 'â›…';  // Partly cloudy
        if (code === 3) return 'â˜ï¸';  // Overcast
        if (code === 45 || code === 48) return 'ðŸŒ«ï¸';  // Fog
        if (code >= 51 && code <= 55) return 'ðŸŒ§ï¸';  // Drizzle
        if (code >= 56 && code <= 57) return 'ðŸŒ§ï¸';  // Freezing drizzle
        if (code >= 61 && code <= 65) return 'ðŸŒ§ï¸';  // Rain
        if (code >= 66 && code <= 67) return 'ðŸŒ§ï¸';  // Freezing rain
        if (code >= 71 && code <= 77) return 'ðŸŒ¨ï¸';  // Snow
        if (code >= 80 && code <= 82) return 'ðŸŒ§ï¸';  // Rain showers
        if (code >= 85 && code <= 86) return 'ðŸŒ¨ï¸';  // Snow showers
        if (code >= 95 && code <= 99) return 'â›ˆï¸';  // Thunderstorm
        return 'ðŸŒ¡ï¸';  // Default
      }

      function updateWeatherVisibility() {
        if (config.showWeather) {
          elements.weatherPanel.className = 'weather-panel';
        } else {
          elements.weatherPanel.className = 'weather-panel hidden';
        }
      }

      function fetchWeather() {
        var url = 'https://api.open-meteo.com/v1/forecast?latitude=' + config.latitude +
                  '&longitude=' + config.longitude +
                  '&current=temperature_2m,relative_humidity_2m,dew_point_2m,weather_code' +
                  '&daily=sunrise,sunset&timezone=auto&forecast_days=2&timeformat=unixtime';

        var xhr = new XMLHttpRequest();
        xhr.open('GET', url, true);
        xhr.onreadystatechange = function() {
          if (xhr.readyState === 4 && xhr.status === 200) {
            try {
              var data = JSON.parse(xhr.responseText);
              if (data.current) {
                elements.weatherTemp.textContent = Math.round(data.current.temperature_2m);
                elements.weatherHumidity.textContent = Math.round(data.current.relative_humidity_2m);

                // Weather condition emoji
                var weatherCode = data.current.weather_code;
                if (weatherCode !== undefined) {
                  elements.weatherCondition.textContent = getWeatherEmoji(weatherCode);
                  elements.weatherCondition.className = 'weather-condition';
                }

                var dewpoint = Math.round(data.current.dew_point_2m);
                var comfort = getDewpointComfort(dewpoint);

                elements.weatherDewpoint.textContent = dewpoint + 'Â°C';
                elements.weatherDewpoint.className = 'dewpoint-value ' + comfort.class;
                elements.dewpointEmoji.textContent = comfort.emoji;
                elements.dewpointEmoji.className = 'dewpoint-emoji ' + comfort.class;

                // Sunrise/sunset: show the next relevant event
                if (data.daily && data.daily.sunrise && data.daily.sunset) {
                  // Store today's sunset for charge cutoff calculation
                  if (data.daily.sunset.length > 0) {
                    todaySunsetUnix = data.daily.sunset[0];
                  }
                  var now = new Date();
                  var sunrises = data.daily.sunrise;
                  var sunsets = data.daily.sunset;
                  var nextSunrise = null;
                  var nextSunset = null;
                  var i;
                  var nowUnix = Math.floor(now.getTime() / 1000);
                  for (i = 0; i < sunrises.length; i++) {
                    if (sunrises[i] > nowUnix) { nextSunrise = new Date(sunrises[i] * 1000); break; }
                  }
                  for (i = 0; i < sunsets.length; i++) {
                    if (sunsets[i] > nowUnix) { nextSunset = new Date(sunsets[i] * 1000); break; }
                  }
                  var sunDate, sunIsRise;
                  if (nextSunrise && nextSunset) {
                    sunIsRise = nextSunrise < nextSunset;
                    sunDate = sunIsRise ? nextSunrise : nextSunset;
                  } else if (nextSunrise) {
                    sunIsRise = true; sunDate = nextSunrise;
                  } else if (nextSunset) {
                    sunIsRise = false; sunDate = nextSunset;
                  }
                  if (sunDate) {
                    var h = sunDate.getHours();
                    var m = sunDate.getMinutes();
                    var timeStr;
                    if (config.use24hClock) {
                      timeStr = h + ':' + (m < 10 ? '0' : '') + m;
                    } else {
                      var ampm = h >= 12 ? 'PM' : 'AM';
                      var h12 = h % 12 || 12;
                      timeStr = h12 + ':' + (m < 10 ? '0' : '') + m + ' ' + ampm;
                    }
                    elements.sunLabel.textContent = sunIsRise ? 'Sunrise' : 'Sunset';
                    elements.sunTime.textContent = timeStr;
                    elements.sunEvent.style.display = '';
                  }
                }
              }
            } catch (e) {
              // Ignore errors
            }
          }
        };
        xhr.send();
      }

      function formatNumber(value, decimals) {
        if (value === null || value === undefined || isNaN(value)) {
          return '--';
        }
        var d = decimals !== undefined ? decimals : 1;
        return Number(value).toFixed(d);
      }

      function isInFreePeriod() {
        var now = new Date();
        var currentHour = now.getHours() + now.getMinutes() / 60;
        var periods = config.freePeriods || [];
        for (var i = 0; i < periods.length; i++) {
          var p = periods[i];
          if (currentHour >= p.start && currentHour < p.end) {
            return true;
          }
        }
        return false;
      }

      function formatTime(date) {
        var hours = date.getHours();
        var minutes = date.getMinutes();
        var seconds = date.getSeconds();
        var hh = hours < 10 ? '0' + hours : '' + hours;
        var mm = minutes < 10 ? '0' + minutes : '' + minutes;
        var ss = seconds < 10 ? '0' + seconds : '' + seconds;
        return hh + ':' + mm + ':' + ss;
      }

      function formatDuration(hours) {
        if (hours <= 0 || !isFinite(hours)) return null;
        var h = Math.floor(hours);
        var m = Math.round((hours - h) * 60);
        if (m === 60) { h++; m = 0; }
        if (h === 0) return m + 'm';
        if (m === 0) return h + 'h';
        return h + 'h ' + m + 'm';
      }

      function formatExpectedTime(hours) {
        if (hours <= 0 || !isFinite(hours)) return null;
        var now = new Date();
        var ms = now.getTime() + (hours * 3600000);
        var future = new Date(ms);
        var hh = future.getHours();
        var mm = future.getMinutes();
        var mmStr = (mm < 10 ? '0' : '') + mm;

        var timeStr;
        if (config.use24hClock) {
          timeStr = (hh < 10 ? '0' : '') + hh + ':' + mmStr;
        } else {
          var period = hh >= 12 ? 'PM' : 'AM';
          var h12 = hh % 12;
          if (h12 === 0) h12 = 12;
          timeStr = h12 + ':' + mmStr + ' ' + period;
        }

        // Determine day offset
        var todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        var futureStart = new Date(future.getFullYear(), future.getMonth(), future.getDate());
        var dayDiff = Math.round((futureStart.getTime() - todayStart.getTime()) / 86400000);

        if (dayDiff === 0) {
          return timeStr;
        } else if (dayDiff === 1) {
          return 'tomorrow at ' + timeStr;
        } else if (dayDiff <= 7) {
          var days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
          return days[future.getDay()] + ' at ' + timeStr;
        } else {
          var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
          return 'on ' + months[future.getMonth()] + ' ' + future.getDate();
        }
      }

      function getVarValue(result, varName) {
        if (!result || !result.result) return null;
        var resultArr = result.result;
        if (!resultArr[0] || !resultArr[0].datas) return null;
        var datas = resultArr[0].datas;
        for (var i = 0; i < datas.length; i++) {
          if (datas[i].variable === varName) {
            return datas[i].value;
          }
        }
        return null;
      }

      function setStatus(status, message) {
        elements.statusDot.className = 'status-dot ' + status;
        elements.statusText.textContent = message;
      }

      function formatLastUpdated(date) {
        if (!date) return '';
        var hours = date.getHours();
        var minutes = date.getMinutes();
        var mm = minutes < 10 ? '0' + minutes : '' + minutes;

        var timeStr;
        if (config.use24hClock) {
          var hh = hours < 10 ? '0' + hours : '' + hours;
          timeStr = hh + ':' + mm;
        } else {
          var period = hours >= 12 ? 'PM' : 'AM';
          var h12 = hours % 12;
          if (h12 === 0) h12 = 12;
          timeStr = h12 + ':' + mm + ' ' + period;
        }
        return timeStr;
      }

      function showError(message) {
        elements.errorMessage.textContent = message;
        elements.errorMessage.style.display = 'block';
        var statusMsg = 'Error';
        if (lastSuccessfulUpdate) {
          statusMsg = 'Last updated ' + formatLastUpdated(lastSuccessfulUpdate);
        }
        setStatus('error', statusMsg);
      }

      function hideError() {
        elements.errorMessage.style.display = 'none';
      }

      function updateRealtimeData(data) {
        if (data.errno !== 0) {
          var msg = data.msg || 'Unknown error';
          showError('API Error: ' + msg);
          return;
        }

        hideError();
        lastSuccessfulUpdate = new Date();
        setStatus('online', 'Connected');

        var soc = getVarValue(data, 'SoC');
        if (soc !== null) {
          elements.socValue.textContent = Math.round(soc);
          var levelHeight = Math.max(0, Math.min(100, soc));
          elements.batteryLevel.style.height = levelHeight + '%';

          elements.batteryLevel.className = 'battery-level';
          if (soc < 20) {
            elements.batteryLevel.className = 'battery-level low';
          } else if (soc < 50) {
            elements.batteryLevel.className = 'battery-level medium';
          }
        }

        var soh = getVarValue(data, 'SoH');
        var ratedCap = apiRatedCapacity !== null ? apiRatedCapacity : config.batterySize;
        var effectiveCap = (soh !== null && soh > 0) ? ratedCap * (soh / 100) : ratedCap;

        var chargePower = getVarValue(data, 'batChargePower');
        var dischargePower = getVarValue(data, 'batDischargePower');
        var batTemp = getVarValue(data, 'batTemperature');

        chargePower = chargePower || 0;
        dischargePower = dischargePower || 0;

        elements.batteryStatus.className = 'battery-status';
        elements.batteryTime.className = 'battery-time hidden';

        if (chargePower > 0.05) {
          elements.batteryStatus.className = 'battery-status charging';
          elements.batteryStatus.textContent = 'Charging ' + formatNumber(chargePower, 2) + ' kW';

          // Calculate time to full
          var remainingCapacity = effectiveCap * (100 - soc) / 100;
          var hoursToFull = remainingCapacity / chargePower;
          var timeStr = formatDuration(hoursToFull);
          var expectedTime = formatExpectedTime(hoursToFull);
          if (timeStr && expectedTime) {
            // Check if expected full time is after charge cutoff (sunset - configured hours)
            var afterCutoff = false;
            if (todaySunsetUnix && config.chargeCutoffHours > 0) {
              var cutoffUnix = todaySunsetUnix - (config.chargeCutoffHours * 3600);
              var expectedFullUnix = Math.floor(Date.now() / 1000) + (hoursToFull * 3600);
              if (expectedFullUnix > cutoffUnix) {
                afterCutoff = true;
              }
            }
            var marker = afterCutoff ? ' *' : '';
            elements.batteryTime.textContent = 'Full in ' + timeStr + ' (' + (expectedTime.indexOf('at') === -1 && expectedTime.indexOf('on ') === -1 ? 'at ' : '') + expectedTime + ')' + marker;
            elements.batteryTime.className = 'battery-time charging';
          }
        } else if (dischargePower > 0.05) {
          elements.batteryStatus.className = 'battery-status discharging';
          elements.batteryStatus.textContent = 'Discharging ' + formatNumber(dischargePower, 2) + ' kW';

          // Calculate time to reserve
          var usablePercent = soc - config.batteryReserve;
          if (usablePercent > 0) {
            var availableCapacity = effectiveCap * usablePercent / 100;
            var hoursToReserve = availableCapacity / dischargePower;
            var timeStr2 = formatDuration(hoursToReserve);
            var expectedTime2 = formatExpectedTime(hoursToReserve);
            if (timeStr2 && expectedTime2) {
              // Check if reserve estimate crosses a free charge period
              var reserveAfterFree = false;
              var periods = config.freePeriods || [];
              if (periods.length > 0) {
                var expectedReserveUnix = Math.floor(Date.now() / 1000) + (hoursToReserve * 3600);
                var expectedReserveDate = new Date(expectedReserveUnix * 1000);
                var reserveHour = expectedReserveDate.getHours() + expectedReserveDate.getMinutes() / 60;
                var nowDate = new Date();
                var nowHour = nowDate.getHours() + nowDate.getMinutes() / 60;
                for (var fp = 0; fp < periods.length; fp++) {
                  var pStart = periods[fp].start;
                  var pEnd = periods[fp].end;
                  // Free period is between now and reserve time
                  if (pStart > nowHour && pStart < nowHour + hoursToReserve) {
                    reserveAfterFree = true;
                    break;
                  }
                  // Reserve time lands inside a free period
                  if (reserveHour >= pStart && reserveHour < pEnd) {
                    reserveAfterFree = true;
                    break;
                  }
                }
              }
              var marker2 = reserveAfterFree ? ' *' : '';
              elements.batteryTime.textContent = 'Reserve in ' + timeStr2 + ' (' + (expectedTime2.indexOf('at') === -1 && expectedTime2.indexOf('on ') === -1 ? 'at ' : '') + expectedTime2 + ')' + marker2;
              elements.batteryTime.className = 'battery-time discharging';
            }
          }
        } else {
          elements.batteryStatus.className = 'battery-status idle';
          elements.batteryStatus.textContent = 'Idle';

          // Blink battery level when at reserve and idle
          if (soc !== null && soc <= config.batteryReserve) {
            elements.batteryLevel.className = elements.batteryLevel.className + ' reserve-blink';
          }
        }

        var details = [];
        // Calculate and show kWh remaining
        if (soc !== null) {
          var kwhRemaining = (soc / 100) * effectiveCap;
          details.push(formatNumber(kwhRemaining, 1) + ' kWh');
        }
        if (soh !== null) {
          details.push('SoH ' + Math.round(soh) + '%');
        }
        if (batTemp !== null) {
          details.push(formatNumber(batTemp, 1) + 'Â°C');
        }
        var rVolt = getVarValue(data, 'RVolt');
        if (rVolt !== null) {
          details.push(formatNumber(rVolt, 0) + ' V');
        }
        elements.batteryDetails.textContent = details.length > 0 ? details.join(' | ') : '--';

        var pvPower = getVarValue(data, 'pvPower');
        var loadsPower = getVarValue(data, 'loadsPower');
        var feedinPower = getVarValue(data, 'feedinPower');
        var gridConsumption = getVarValue(data, 'gridConsumptionPower');

        elements.solarPower.textContent = formatNumber(pvPower, 2);
        elements.loadPower.textContent = formatNumber(loadsPower, 2);
        elements.gridExport.textContent = formatNumber(feedinPower, 2);
        elements.gridImport.textContent = formatNumber(gridConsumption, 2);

        // Update grid import color based on free period
        if (isInFreePeriod()) {
          elements.gridImportCard.className = 'stat-card grid-import free-period';
        } else {
          elements.gridImportCard.className = 'stat-card grid-import';
        }
      }

      function fetchDeviceDetail() {
        if (!config.workerUrl || !config.apiKey) return;
        var xhr = new XMLHttpRequest();
        xhr.open('GET', config.workerUrl + '/api/device-detail', true);
        xhr.setRequestHeader('X-API-Key', config.apiKey);
        xhr.onreadystatechange = function() {
          if (xhr.readyState === 4 && xhr.status === 200) {
            try {
              var resp = JSON.parse(xhr.responseText);
              if (resp && resp.result && resp.result.batteryList) {
                var list = resp.result.batteryList;
                var total = 0;
                for (var i = 0; i < list.length; i++) {
                  total += list[i].capicty || 0;
                }
                if (total > 0) {
                  apiRatedCapacity = total;
                }
              }
            } catch (e) {}
          }
        };
        xhr.send();
      }

      function fetchData() {
        if (!config.workerUrl) {
          elements.noConfig.style.display = 'block';
          elements.dashboard.style.display = 'none';
          setStatus('', 'Not configured');
          return;
        }

        elements.noConfig.style.display = 'none';
        elements.dashboard.style.display = 'block';
        setStatus('', 'Updating...');

        var xhr1 = new XMLHttpRequest();
        xhr1.open('POST', config.workerUrl + '/api/realtime', true);
        xhr1.setRequestHeader('Content-Type', 'application/json');
        if (config.apiKey) {
          xhr1.setRequestHeader('X-API-Key', config.apiKey);
        }
        xhr1.onreadystatechange = function() {
          if (xhr1.readyState === 4) {
            if (xhr1.status === 200) {
              try {
                var data = JSON.parse(xhr1.responseText);
                try {
                  updateRealtimeData(data);
                } catch (e2) {
                  showError('Update error: ' + e2.message);
                }
              } catch (e) {
                showError('JSON error: ' + e.message);
              }
            } else if (xhr1.status === 0) {
              showError('CORS or network error');
            } else {
              showError('Error ' + xhr1.status);
            }
          }
        };
        xhr1.onerror = function() {
          showError('Network error');
        };
        xhr1.send('{}');
      }

      function updateCountdown() {
        var isOnline = elements.statusDot.className.indexOf('online') !== -1;
        var isError = elements.statusDot.className.indexOf('error') !== -1;

        if (isOnline) {
          var remaining = Math.round((nextRefreshTime - Date.now()) / 1000);
          if (remaining < 0) remaining = 0;
          elements.statusText.textContent = 'Connected \u00b7 ' + remaining + 's';
        } else if (isError && lastSuccessfulUpdate) {
          elements.statusText.textContent = 'Last updated ' + formatLastUpdated(lastSuccessfulUpdate);
        }
      }

      function startAutoRefresh() {
        if (refreshTimer) clearInterval(refreshTimer);
        if (countdownTimer) clearInterval(countdownTimer);
        var intervalMs = Math.max(10, config.refreshInterval) * 1000;
        nextRefreshTime = Date.now() + intervalMs;
        refreshTimer = setInterval(function() {
          nextRefreshTime = Date.now() + intervalMs;
          fetchData();
        }, intervalMs);
        countdownTimer = setInterval(updateCountdown, 1000);
      }

      function renderFreePeriods() {
        var container = elements.freePeriodsContainer;
        container.innerHTML = '';
        var periods = config.freePeriods || [];
        for (var i = 0; i < periods.length; i++) {
          var p = periods[i];
          var row = document.createElement('div');
          row.className = 'free-period-row';
          row.innerHTML = '<input type="number" class="period-start" value="' + p.start + '" min="0" max="23" step="1">' +
            '<span class="period-label">to</span>' +
            '<input type="number" class="period-end" value="' + p.end + '" min="0" max="24" step="1">' +
            '<span class="period-label">hrs</span>' +
            '<button type="button" class="remove-period">x</button>';
          container.appendChild(row);
        }
        // Add remove handlers
        var removeButtons = container.querySelectorAll('.remove-period');
        for (var j = 0; j < removeButtons.length; j++) {
          (function(idx) {
            removeButtons[idx].onclick = function() {
              config.freePeriods.splice(idx, 1);
              renderFreePeriods();
            };
          })(j);
        }
      }

      function collectFreePeriods() {
        var periods = [];
        var rows = elements.freePeriodsContainer.querySelectorAll('.free-period-row');
        for (var i = 0; i < rows.length; i++) {
          var start = parseInt(rows[i].querySelector('.period-start').value, 10);
          var end = parseInt(rows[i].querySelector('.period-end').value, 10);
          if (!isNaN(start) && !isNaN(end) && end > start) {
            periods.push({start: start, end: end});
          }
        }
        return periods;
      }

      function openSettings() {
        elements.workerUrl.value = config.workerUrl;
        elements.apiKey.value = config.apiKey;
        elements.refreshInterval.value = config.refreshInterval;
        elements.latitude.value = config.latitude;
        elements.longitude.value = config.longitude;
        elements.batterySize.value = config.batterySize;
        elements.batteryReserve.value = config.batteryReserve;
        elements.chargeCutoffHours.value = config.chargeCutoffHours;
        elements.showWeather.checked = config.showWeather;
        elements.use24hClock.checked = config.use24hClock;
        renderFreePeriods();
        elements.settingsOverlay.className = 'settings-overlay active';
      }

      function closeSettings() {
        elements.settingsOverlay.className = 'settings-overlay';
      }

      function exportSettings() {
        var exportData = JSON.stringify(config, null, 2);
        var blob = new Blob([exportData], { type: 'application/json' });
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = 'foxess-dashboard-settings.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      function importSettings(file) {
        var reader = new FileReader();
        reader.onload = function(e) {
          try {
            var imported = JSON.parse(e.target.result);
            if (imported.workerUrl !== undefined) config.workerUrl = imported.workerUrl;
            if (imported.apiKey !== undefined) config.apiKey = imported.apiKey;
            if (imported.refreshInterval !== undefined) config.refreshInterval = imported.refreshInterval;
            if (imported.latitude !== undefined) config.latitude = imported.latitude;
            if (imported.longitude !== undefined) config.longitude = imported.longitude;
            if (imported.showWeather !== undefined) config.showWeather = imported.showWeather;
            if (imported.batterySize !== undefined) config.batterySize = imported.batterySize;
            if (imported.batteryReserve !== undefined) config.batteryReserve = imported.batteryReserve;
            if (imported.chargeCutoffHours !== undefined) config.chargeCutoffHours = imported.chargeCutoffHours;
            if (imported.use24hClock !== undefined) config.use24hClock = imported.use24hClock;
            if (imported.freePeriods !== undefined) config.freePeriods = imported.freePeriods;
            saveConfig();
            openSettings();
            var importBtn = document.getElementById('importSettings');
            if (importBtn) {
              importBtn.textContent = 'Imported!';
              setTimeout(function() { importBtn.textContent = 'Import Settings'; }, 2000);
            }
          } catch (err) {
            alert('Failed to import settings: Invalid JSON file');
          }
        };
        reader.readAsText(file);
      }

      function initSettings() {
        var settingsBtn = document.getElementById('settingsBtn');
        var settingsClose = document.getElementById('settingsClose');
        var settingsSave = document.getElementById('settingsSave');
        var settingsReload = document.getElementById('settingsReload');
        var settingsVersion = document.getElementById('settingsVersion');
        var openSettingsBtn = document.getElementById('openSettingsBtn');
        var refreshBtn = document.getElementById('refreshBtn');
        var updateBtn = document.getElementById('updateBtn');

        // Set version display
        if (settingsVersion) {
          settingsVersion.textContent = 'v' + APP_VERSION;
        }

        settingsBtn.onclick = openSettings;
        if (openSettingsBtn) {
          openSettingsBtn.onclick = openSettings;
        }
        settingsClose.onclick = closeSettings;

        elements.addFreePeriod.onclick = function() {
          config.freePeriods.push({start: 0, end: 6});
          renderFreePeriods();
        };

        settingsSave.onclick = function() {
          var url = elements.workerUrl.value;
          if (url && url.charAt(url.length - 1) === '/') {
            url = url.substring(0, url.length - 1);
          }
          config.workerUrl = url;
          config.apiKey = elements.apiKey.value;
          config.refreshInterval = parseInt(elements.refreshInterval.value, 10) || 180;
          config.latitude = parseFloat(elements.latitude.value) || -27.47;
          config.longitude = parseFloat(elements.longitude.value) || 153.02;
          config.batterySize = parseFloat(elements.batterySize.value) || 41;
          config.batteryReserve = parseInt(elements.batteryReserve.value, 10) || 10;
          config.chargeCutoffHours = parseFloat(elements.chargeCutoffHours.value) || 2.5;
          config.freePeriods = collectFreePeriods();
          config.showWeather = elements.showWeather.checked;
          config.use24hClock = elements.use24hClock.checked;
          saveConfig();
          updateWeatherVisibility();
          updateClock();
          closeSettings();
          fetchData();
          fetchWeather();
          startAutoRefresh();
        };

        refreshBtn.onclick = function() {
          fetchData();
          startAutoRefresh();
        };

        var exportBtn = document.getElementById('exportSettings');
        var importBtn = document.getElementById('importSettings');
        var importFileInput = document.getElementById('importFileInput');

        if (exportBtn) {
          exportBtn.onclick = exportSettings;
        }
        if (importBtn && importFileInput) {
          importBtn.onclick = function() {
            importFileInput.click();
          };
          importFileInput.onchange = function() {
            if (importFileInput.files && importFileInput.files[0]) {
              importSettings(importFileInput.files[0]);
              importFileInput.value = '';
            }
          };
        }

        if (settingsReload) {
          settingsReload.onclick = forceReload;
        }

        if (updateBtn) {
          updateBtn.onclick = forceReload;
        }

        elements.settingsOverlay.onclick = function(e) {
          if (e.target === elements.settingsOverlay) {
            closeSettings();
          }
        };
      }

      function init() {
        initElements();
        loadConfig();
        checkForUpdates();
        updateWeatherVisibility();
        initSettings();
        fetchDeviceDetail();
        fetchData();
        startAutoRefresh();
        updateClock();
        setInterval(updateClock, 1000);
        fetchWeather();
        setInterval(fetchWeather, 600000); // Update weather every 10 minutes
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init, false);
      } else {
        init();
      }
    })();
  </script>
</body>
</html>
